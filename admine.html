<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qoutok - ØºØ±ÙØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #111827; --card: #1f2937; --primary: #25f4ee; --danger: #ef4444; --warning: #f59e0b; --text: #f3f4f6; --sidebar: #0f1115; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: 'Tajawal', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: var(--card); padding: 40px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; border: 1px solid var(--primary); }
        .login-input { width: 100%; padding: 12px; margin: 20px 0; background: #000; border: 1px solid #333; color: white; border-radius: 8px; }
        
        /* Layout */
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #333; display: flex; flex-direction: column; padding: 20px; }
        .logo { font-size: 2rem; color: var(--primary); font-weight: 900; margin-bottom: 40px; text-align: center; letter-spacing: 1px; }
        .menu-item { padding: 15px; cursor: pointer; border-radius: 10px; color: #aaa; transition: 0.3s; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: rgba(37, 244, 238, 0.1); color: white; border-right: 3px solid var(--primary); }
        
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #111827; }
        .section { display: none; animation: fade 0.3s; }
        .section.active { display: block; }
        
        /* Cards & Components */
        .card { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #374151; margin-bottom: 20px; position: relative; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-num { font-size: 2.5rem; font-weight: bold; margin-top: 10px; }
        
        /* Report Card Styling */
        .report-card { border-left: 4px solid var(--danger); }
        .report-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: #aaa; }
        .reported-post { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px dashed #555; }
        
        /* User Table */
        .user-table { width: 100%; border-collapse: collapse; }
        .user-table th, .user-table td { padding: 15px; text-align: right; border-bottom: 1px solid #374151; }
        .user-table th { color: var(--primary); }
        .u-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-left: 10px; }
        
        /* Buttons */
        .btn { padding: 8px 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-left: 5px; }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); } .btn-danger:hover { background: var(--danger); color: white; }
        .btn-primary { background: var(--primary); color: black; width: 100%; padding: 12px; }
        .btn-action { background: #374151; color: white; font-size: 0.8rem; }

        input, textarea { width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: white; border-radius: 10px; margin-bottom: 15px; font-family: inherit; }

        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:20px;">ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <input type="password" id="pass-key" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn btn-primary" onclick="Auth.check()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo">Qoutok</div>
        <div class="menu-item active" onclick="Nav.to('dash')"><i class="fas fa-chart-pie"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
        <div class="menu-item" onclick="Nav.to('reports')"><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª <span id="badge-reports" style="background:var(--danger); color:white; padding:2px 6px; border-radius:10px; font-size:0.7rem; margin-right:auto;">0</span></div>
        <div class="menu-item" onclick="Nav.to('users')"><i class="fas fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
        <div class="menu-item" onclick="Nav.to('posts')"><i class="fas fa-stream"></i> Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</div>
        <div class="menu-item" onclick="Nav.to('broadcast')"><i class="fas fa-bullhorn"></i> Ø¥Ø°Ø§Ø¹Ø© Ø¹Ø§Ù…Ø©</div>
        <div class="menu-item" onclick="Nav.to('messages')"><i class="fas fa-envelope"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
    </div>

    <div class="main-content">
        
        <div id="sec-dash" class="section active">
            <h2>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
            <div class="stat-grid">
                <div class="card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3><div class="stat-num" id="st-users">0</div></div>
                <div class="card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h3><div class="stat-num" id="st-posts">0</div></div>
                <div class="card"><h3>Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3><div class="stat-num" id="st-reports" style="color:var(--danger);">0</div></div>
            </div>
        </div>

        <div id="sec-reports" class="section">
            <h2 style="margin-bottom: 20px; color:var(--danger);">ğŸš¨ Ù…Ø±ÙƒØ² Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h2>
            <div id="reports-list"></div>
        </div>

        <div id="sec-users" class="section">
            <h2>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h2>
            <div class="card" style="overflow-x:auto;">
                <table class="user-table">
                    <thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Uid</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="sec-posts" class="section">
            <h2>Ø¢Ø®Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h2>
            <div id="posts-list"></div>
        </div>

        <div id="sec-broadcast" class="section">
            <div class="card" style="max-width:500px;">
                <h2>ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù…</h2>
                <p style="color:#aaa; margin-bottom:15px;">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ ÙƒØ±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                <input type="text" id="b-title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                <textarea id="b-body" rows="4" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea>
                <button class="btn btn-primary" onclick="Admin.broadcast()">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
            </div>
        </div>

        <div id="sec-messages" class="section">
            <h2>Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„</h2>
            <div id="msg-list"></div>
        </div>

    </div>

<script>
// ğŸ”¥ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ğŸ”¥
const firebaseConfig = {
    apiKey: "AIzaSyAfz9k1oG3rwiv4Lsfy7Dl92PxuzsrYqB8",
    authDomain: "qoutok.firebaseapp.com",
    projectId: "qoutok",
    storageBucket: "qoutok.firebasestorage.app",
    messagingSenderId: "580116525824",
    appId: "1:580116525824:web:d855472417f0682f2c39e5",
    measurementId: "G-RETNEQJCKB"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const Auth = {
    check() {
        if(document.getElementById('pass-key').value === "ahmad123") {
            document.getElementById('login-screen').style.display = 'none';
            Admin.init();
        } else alert("Ø®Ø·Ø£");
    }
};

const Nav = {
    to(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
        event.currentTarget.classList.add('active');
    }
};

const Admin = {
    init() {
        this.loadStats();
        this.loadReports();
        this.loadUsers();
        this.loadPosts();
        this.loadMessages();
    },

    loadStats() {
        db.ref('posts').on('value', s => document.getElementById('st-posts').innerText = s.numChildren());
        db.ref('users').on('value', s => document.getElementById('st-users').innerText = s.numChildren());
        db.ref('reports').on('value', s => {
            const count = s.numChildren();
            document.getElementById('st-reports').innerText = count;
            document.getElementById('badge-reports').innerText = count;
        });
    },

    // --- ğŸš¨ 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª (Ø§Ù„Ø£Ù‡Ù…) ---
    loadReports() {
        db.ref('reports').on('value', snap => {
            const div = document.getElementById('reports-list');
            div.innerHTML = '';
            if(!snap.exists()) div.innerHTML = '<p style="color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ø¬Ø¯ÙŠØ¯Ø© âœ…</p>';
            
            snap.forEach(child => {
                const reportId = child.key;
                const postId = child.val(); // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚Ù†Ø§ Ø§Ù„Ø¨Ø³ÙŠØ·ØŒ Ø­ÙØ¸Ù†Ø§ Ø§Ù„Ù€ ID ÙÙ‚Ø·
                
                // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù†Ù‡
                db.ref('posts/' + postId).once('value', pSnap => {
                    const p = pSnap.val();
                    if(p) {
                        div.innerHTML += `
                            <div class="card report-card">
                                <div class="report-header">
                                    <span>Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯</span>
                                    <button class="btn btn-action" onclick="Admin.resolveReport('${reportId}')">ØªØ¬Ø§Ù‡Ù„</button>
                                </div>
                                <div class="reported-post">
                                    <strong>${p.authorName}</strong> (${p.uid})<br>
                                    <p style="margin-top:5px; font-size:1.1rem;">"${p.text}"</p>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button class="btn btn-danger" onclick="Admin.deletePost('${postId}', '${reportId}')">Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
                                    <button class="btn btn-danger" style="background:#7f1d1d;" onclick="Admin.banUser('${p.uid}', '${p.authorName}')">ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                                </div>
                            </div>
                        `;
                    } else {
                        // Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù…Ø­Ø°ÙˆÙ Ø£ØµÙ„Ø§Ù‹
                        Admin.resolveReport(reportId);
                    }
                });
            });
        });
    },

    resolveReport(reportId) {
        db.ref('reports/' + reportId).remove();
    },

    // --- ğŸ‘¥ 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ---
    loadUsers() {
        db.ref('users').on('value', snap => {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            snap.forEach(child => {
                const u = child.val();
                const uid = child.key;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±
                db.ref('banned_users/' + uid).once('value', banSnap => {
                    const isBanned = banSnap.exists();
                    const statusHtml = isBanned ? '<span style="color:red">Ù…Ø­Ø¸ÙˆØ±</span>' : '<span style="color:green">Ù†Ø´Ø·</span>';
                    const actionBtn = isBanned 
                        ? `<button class="btn btn-action" onclick="Admin.unbanUser('${uid}')">ÙÙƒ Ø§Ù„Ø­Ø¸Ø±</button>`
                        : `<button class="btn btn-danger" onclick="Admin.banUser('${uid}', '${u.name}')">Ø­Ø¸Ø±</button>`;

                    tbody.innerHTML += `
                        <tr>
                            <td>${u.name} <img src="${u.photo}" class="u-img"></td>
                            <td style="font-size:0.8rem; color:#777;">${uid}</td>
                            <td>${statusHtml}</td>
                            <td>${actionBtn}</td>
                        </tr>
                    `;
                });
            });
        });
    },

    banUser(uid, name) {
        if(confirm(`Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${name} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) {
            db.ref('banned_users/' + uid).set({ reason: 'Admin Ban', date: Date.now() });
            alert("ØªÙ… Ø§Ù„Ø­Ø¸Ø±!");
            this.loadUsers(); // Refresh
        }
    },

    unbanUser(uid) {
        if(confirm('ÙÙƒ Ø§Ù„Ø­Ø¸Ø±ØŸ')) {
            db.ref('banned_users/' + uid).remove();
            alert("ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø±.");
            this.loadUsers();
        }
    },

    // --- ğŸ“¢ 3. Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© ---
    broadcast() {
        const t = document.getElementById('b-title').value;
        const b = document.getElementById('b-body').value;
        if(t) db.ref('announcements').push({ title: t, body: b, date: Date.now() }).then(()=>alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!"));
    },

    // --- ğŸ“ 4. Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ---
    loadPosts() {
        db.ref('posts').limitToLast(20).on('value', snap => {
            const div = document.getElementById('posts-list');
            div.innerHTML = '';
            snap.forEach(child => {
                const p = child.val();
                div.innerHTML = `
                    <div class="card" style="display:flex; justify-content:space-between;">
                        <div>${p.text.substring(0,50)}... <br><small>${p.authorName}</small></div>
                        <button class="btn btn-danger" onclick="Admin.deletePost('${child.key}')">Ø­Ø°Ù</button>
                    </div>
                ` + div.innerHTML;
            });
        });
    },

    deletePost(postId, reportId = null) {
        if(confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ')) {
            db.ref('posts/' + postId).remove();
            if(reportId) db.ref('reports/' + reportId).remove();
        }
    },

    // --- âœ‰ï¸ 5. Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
    loadMessages() {
        db.ref('messages').limitToLast(20).on('value', snap => {
            const div = document.getElementById('msg-list');
            div.innerHTML = '';
            snap.forEach(child => {
                const m = child.val();
                div.innerHTML = `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; color:#aaa; font-size:0.8rem;">
                            <span>${m.email}</span>
                            <span>${new Date(m.date).toLocaleDateString()}</span>
                        </div>
                        <p style="margin-top:10px;">${m.message}</p>
                    </div>
                ` + div.innerHTML;
            });
        });
    }
};
</script>
</body>
</html>